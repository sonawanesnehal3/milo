{"version":3,"file":"samplerum-c14e9218.js","sources":["../../libs/utils/samplerum.js"],"sourcesContent":["// code from https://github.com/adobe/helix-rum-js/blob/main/src/index.js\nexport function sampleRUM(checkpoint, data = {}) {\n  const SESSION_STORAGE_KEY = 'aem-rum';\n  sampleRUM.baseURL = sampleRUM.baseURL || new URL(window.RUM_BASE == null ? 'https://rum.hlx.page' : window.RUM_BASE, window.location);\n  sampleRUM.defer = sampleRUM.defer || [];\n  const defer = (fnname) => {\n    sampleRUM[fnname] = sampleRUM[fnname]\n      || ((...args) => sampleRUM.defer.push({ fnname, args }));\n  };\n  /* c8 ignore start */\n  sampleRUM.drain = sampleRUM.drain\n    || ((dfnname, fn) => {\n      sampleRUM[dfnname] = fn;\n      sampleRUM.defer\n        .filter(({ fnname }) => dfnname === fnname)\n        .forEach(({ fnname, args }) => sampleRUM[fnname](...args));\n    });\n  sampleRUM.always = sampleRUM.always || [];\n  sampleRUM.always.on = (chkpnt, fn) => {\n    sampleRUM.always[chkpnt] = fn;\n  };\n  sampleRUM.on = (chkpnt, fn) => {\n    sampleRUM.cases[chkpnt] = fn;\n  };\n  /* c8 ignore stop */\n  defer('observe');\n  defer('cwv');\n  try {\n    window.hlx = window.hlx || {};\n    if (!window.hlx.rum) {\n      const usp = new URLSearchParams(window.location.search);\n      const weight = (usp.get('rum') === 'on') ? 1 : 100; // with parameter, weight is 1. Defaults to 100.\n      const id = Array.from({ length: 75 }, (_, i) => String.fromCharCode(48 + i)).filter((a) => /\\d|[A-Z]/i.test(a)).filter(() => Math.random() * 75 > 70).join('');\n      const random = Math.random();\n      const isSelected = (random * weight < 1);\n      const firstReadTime = Date.now();\n      const urlSanitizers = {\n        full: () => window.location.href,\n        origin: () => window.location.origin,\n        path: () => window.location.href.replace(/\\?.*$/, ''),\n      };\n      // eslint-disable-next-line max-len\n      const rumSessionStorage = sessionStorage.getItem(SESSION_STORAGE_KEY) ? JSON.parse(sessionStorage.getItem(SESSION_STORAGE_KEY)) : {};\n      rumSessionStorage.pages = rumSessionStorage.pages ? rumSessionStorage.pages + 1 : 1;\n      sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(rumSessionStorage));\n      // eslint-disable-next-line object-curly-newline, max-len\n      window.hlx.rum = { weight, id, random, isSelected, firstReadTime, sampleRUM, sanitizeURL: urlSanitizers[window.hlx.RUM_MASK_URL || 'path'], rumSessionStorage };\n    }\n\n    const { weight, id, firstReadTime } = window.hlx.rum;\n    if (window.hlx && window.hlx.rum && window.hlx.rum.isSelected) {\n      const knownProperties = ['weight', 'id', 'referer', 'checkpoint', 't', 'source', 'target', 'cwv', 'CLS', 'FID', 'LCP', 'INP', 'TTFB'];\n      const sendPing = (pdata = data) => {\n        // eslint-disable-next-line object-curly-newline, max-len, no-use-before-define\n        const body = JSON.stringify({ weight, id, referer: window.hlx.rum.sanitizeURL(), checkpoint, t: (Date.now() - firstReadTime), ...data }, knownProperties);\n        const url = new URL(`.rum/${weight}`, sampleRUM.baseURL).href;\n        navigator.sendBeacon(url, body);\n        // eslint-disable-next-line no-console\n        console.debug(`ping:${checkpoint}`, pdata);\n      };\n      sampleRUM.cases = sampleRUM.cases || {\n        load: () => sampleRUM('pagesviewed', { source: window.hlx.rum.rumSessionStorage.pages }) || true,\n        cwv: () => sampleRUM.cwv(data) || true,\n        /* c8 ignore next 7 */\n        lazy: () => {\n          // use classic script to avoid CORS issues\n          const script = document.createElement('script');\n          script.src = new URL('.rum/@adobe/helix-rum-enhancer@^1/src/index.js', sampleRUM.baseURL).href;\n          document.head.appendChild(script);\n          return true;\n        },\n      };\n      sendPing(data);\n      if (sampleRUM.cases[checkpoint]) {\n        sampleRUM.cases[checkpoint]();\n      }\n    }\n    if (sampleRUM.always[checkpoint]) {\n      sampleRUM.always[checkpoint](data);\n    }\n  } catch (error) {\n    // something went wrong\n  }\n}\n\n/* c8 ignore start */\nexport function addRumListeners() {\n  window.addEventListener('load', () => sampleRUM('load'));\n\n  window.addEventListener('unhandledrejection', (event) => {\n    sampleRUM('error', { source: event.reason.sourceURL, target: event.reason.line });\n  });\n\n  window.addEventListener('error', (event) => {\n    sampleRUM('error', { source: event.filename, target: event.lineno });\n  });\n}\n/* c8 ignore stop */\n\nsampleRUM('top');\n"],"names":["sampleRUM","checkpoint","data","SESSION_STORAGE_KEY","baseURL","URL","window","RUM_BASE","location","defer","fnname","push","args","slice","call","arguments","drain","dfnname","fn","filter","forEach","always","on","chkpnt","cases","hlx","rum","usp","URLSearchParams","search","weight","get","id","Array","from","length","_","i","String","fromCharCode","a","test","Math","random","join","isSelected","firstReadTime","Date","now","urlSanitizers","full","href","origin","path","replace","rumSessionStorage","sessionStorage","getItem","JSON","parse","pages","setItem","stringify","sanitizeURL","RUM_MASK_URL","knownProperties","sendPing","pdata","body","referer","t","url","navigator","sendBeacon","console","debug","load","source","cwv","lazy","script","document","createElement","src","head","appendChild","error","addRumListeners","addEventListener","event","reason","sourceURL","target","line","filename","lineno"],"mappings":"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"}